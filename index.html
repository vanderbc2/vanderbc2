<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque de Placas Eletrônicas</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SheetJS para exportação Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* [SEU CSS EXISTENTE - MANTIDO IGUAL] */
        :root {
            --primary-color: #00ff88;
            --primary-dark: #00cc6a;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --laranja-laboratorio: #ffa500;
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding-top: 20px;
        }
        
        /* ... [RESTANTE DO CSS PERMANECE IGUAL] ... */
        
    </style>
</head>
<body>
    <!-- Modal de Login -->
    <div class="modal fade" id="login-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Acesso ao Sistema</h5>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-senha" class="form-label">Senha de Acesso</label>
                            <input type="password" class="form-control" id="login-senha" required autocomplete="off">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="lembrar-senha">
                            <label class="form-check-label" for="lembrar-senha">Lembrar senha</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btn-acessar" onclick="verificarSenha()">
                        <span id="btn-login-text">Acessar</span>
                        <span id="btn-login-loading" class="loading-spinner" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- [RESTANTE DO HTML PERMANECE IGUAL] -->
    <nav class="navbar navbar-expand-lg navbar-dark" id="main-navbar" style="display: none;">
        <!-- ... conteúdo da navbar ... -->
    </nav>

    <!-- [RESTANTE DAS SEÇÕES PERMANECE IGUAL] -->

    <!-- SCRIPTS CORRIGIDOS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ========== CONFIGURAÇÃO DE SEGURANÇA ==========
        
        // Configuração do Supabase
        const SUPABASE_URL = 'https://gsmbnpocopxqxvgilmbu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzbWJucG9jb3B4cXh2Z2lsbWJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNDgwNjMsImV4cCI6MjA3NjYyNDA2M30.CSnPADpx3ZFZG2t2AKYad8aXJ7s3xEAYt0hKVNcJMqE';
        
        // Senha de acesso (ALTERE AQUI SE DESEJAR)
        const SENHA_ACESSO = "lab123";
        
        // Chave para armazenamento da senha
        const SENHA_STORAGE_KEY = "estoque_placas_senha";

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Sistema de armazenamento local (fallback)
        const STORAGE_KEYS = {
            PLACAS: 'controle_placas_estoque',
            HISTORICO: 'controle_placas_historico'
        };

        // Variáveis globais
        let placas = [];
        let historicoLancamentos = [];
        let usandoSupabase = false;
        let intervaloAtualizacao = null;
        let loginModal = null;

        // Mapeamento de finalidades para nomes amigáveis
        const FINALIDADES = {
            'rancho_producao': 'Rancho de Produção',
            'master': 'Master',
            'retrabalho_adequacao': 'Retrabalho de adequação',
            'adequacao': 'Adequação',
            'devolucao_estoque': 'Devolução ao Estoque',
            'sucata': 'Sucata',
            'outros': 'Outros'
        };

        // Limite para estoque baixo
        const LIMITE_ESTOQUE_BAIXO = 10;

        // ========== SISTEMA DE SEGURANÇA CORRIGIDO ==========

        // Função para verificar se o usuário está autenticado
        function verificarAutenticacao() {
            const senhaSalva = localStorage.getItem(SENHA_STORAGE_KEY);
            if (senhaSalva) {
                try {
                    return senhaSalva === btoa(SENHA_ACESSO);
                } catch (e) {
                    localStorage.removeItem(SENHA_STORAGE_KEY);
                    return false;
                }
            }
            return false;
        }

        // Função para verificar senha - CORRIGIDA
        function verificarSenha() {
            const senhaInput = document.getElementById('login-senha').value;
            const lembrarSenha = document.getElementById('lembrar-senha').checked;
            
            console.log('Senha digitada:', senhaInput); // Para debug
            console.log('Senha esperada:', SENHA_ACESSO); // Para debug
            
            if (senhaInput === SENHA_ACESSO) {
                if (lembrarSenha) {
                    localStorage.setItem(SENHA_STORAGE_KEY, btoa(SENHA_ACESSO));
                }
                fecharModalLogin();
                mostrarSistema();
            } else {
                mostrarMensagem('❌ Senha incorreta', 'danger');
                // Limpar campo de senha
                document.getElementById('login-senha').value = '';
                document.getElementById('login-senha').focus();
            }
        }

        // Função para fechar o modal de login corretamente - CORRIGIDA
        function fecharModalLogin() {
            if (loginModal) {
                const modalElement = document.getElementById('login-modal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Remover o backdrop do modal manualmente se necessário
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => {
                    backdrop.parentNode.removeChild(backdrop);
                });
                
                // Restaurar o scroll do body
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            }
        }

        // Função para mostrar o sistema após autenticação
        function mostrarSistema() {
            document.getElementById('main-navbar').style.display = 'flex';
            
            // Inicializar o sistema
            inicializarSistema();
        }

        // Função para logout
        function logout() {
            localStorage.removeItem(SENHA_STORAGE_KEY);
            location.reload();
        }

        // ========== INICIALIZAÇÃO CORRIGIDA ==========

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - Iniciando verificação de autenticação');
            
            // Verificar autenticação
            if (verificarAutenticacao()) {
                console.log('Usuário já autenticado');
                mostrarSistema();
            } else {
                console.log('Usuário não autenticado - mostrando modal');
                // Mostrar modal de login
                const modalElement = document.getElementById('login-modal');
                loginModal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
                loginModal.show();
                
                // Focar no campo de senha
                modalElement.addEventListener('shown.bs.modal', function() {
                    document.getElementById('login-senha').focus();
                });
            }
            
            // Event listener para tecla Enter no login
            document.getElementById('login-senha').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarSenha();
                }
            });
        });

        // ========== FUNÇÕES RESTANTES (MANTIDAS) ==========

        // Função para inicializar o sistema
        function inicializarSistema() {
            console.log('Inicializando sistema...');
            
            // Configurar data atual
            document.getElementById('data-movimentacao').value = obterDataAtual();
            
            // Event listeners
            document.getElementById('form-placa').addEventListener('submit', salvarPlaca);
            document.getElementById('form-movimentacao').addEventListener('submit', registrarMovimentacao);
            
            // Navegação entre seções
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Atualizar navegação
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar seção correspondente
                    const sectionId = this.getAttribute('data-section');
                    document.querySelectorAll('.page-section').forEach(section => {
                        section.classList.remove('active-section');
                    });
                    document.getElementById(sectionId).classList.add('active-section');
                });
            });
            
            // Event listener para mudança de tipo de gráfico
            document.getElementById('tipo-grafico').addEventListener('change', atualizarGraficoEstoque);
            
            // Carregar dados iniciais
            carregarDados().then(() => {
                configurarAtualizacoesTempoReal();
            });
        }

        // Função para mostrar mensagens
        function mostrarMensagem(mensagem, tipo) {
            const alert = document.getElementById('alert-atualizacao');
            const mensagemElem = document.getElementById('mensagem-atualizacao');
            
            alert.className = `alert alert-${tipo} alert-dismissible fade show`;
            mensagemElem.textContent = mensagem;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 4000);
        }

        // [RESTANTE DAS FUNÇÕES PERMANECE IGUAL...]
        // ... incluir todas as outras funções do código original ...

        // Função para obter data atual
        function obterDataAtual() {
            return new Date().toISOString().split('T')[0];
        }

        // Sistema de armazenamento local (fallback)
        function salvarNoLocalStorage(chave, dados) {
            localStorage.setItem(chave, JSON.stringify(dados));
        }

        function carregarDoLocalStorage(chave) {
            const dados = localStorage.getItem(chave);
            return dados ? JSON.parse(dados) : [];
        }

        // ========== FUNÇÕES SUPABASE ==========

        // Carregar placas do Supabase
        async function carregarPlacasSupabase() {
            try {
                const { data, error } = await supabase
                    .from('placas')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Erro ao carregar placas:', error);
                throw error;
            }
        }

        // [CONTINUAR COM TODAS AS OUTRAS FUNÇÕES DO CÓDIGO ORIGINAL...]

    </script>
</body>
</html>